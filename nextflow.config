/**
	Yet Another Metagenomic Pipeline (YAMP)
	Copyright (C) 2017 	Dr Alessia Visconti 	      
	      
	This script is free software: you can redistribute it and/or modify
	it under the terms of the GNU General Public License as published by
	the Free Software Foundation, either version 3 of the License, or
	(at your option) any later version.
	
	This script is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU General Public License for more details.
	
	You should have received a copy of the GNU General Public License
	along with this script.  If not, see <http://www.gnu.org/licenses/>.
	
	For any bugs or problems found, please contact us at
	- alessia.visconti@kcl.ac.uk ; 
	- https://github.com/alesssia/YAMP/issues
*/

manifest
{
  homePage = 'https://github.com/alesssia/YAMP'
  description = 'YAMP : Yet Another Metagenomic Pipeline'
  mainScript = 'YAMP.nf'
}

trace 
{
    enabled = true
    fields = 'task_id, name, status, exit, module, submit, start, complete, duration, realtime, %cpu, rss, vmem, peak_rss, peak_vmem'
}

report
{
	enabled = true
	file = "computing_report.html"
}

timeline 
{
    enabled = true
}


params 
{
	//DO NOT CHANGE
	
	//These are used when the analysis is in characterisation mode
	reads1 = "null"
	reads2 = "null"
	
	//These are used to print version and help
	help = null
	version = null
	
	/*--------------------------------*
	 *	EXECUTION FLOW PARAMETERS
	 *--------------------------------*/	

	//Whether it shold perform only QC, community characterisation, or both (default: both)
	mode="complete"
	qc = false
	kraken2 = false
	humann2 = false
	//profiling method = humann2|mg-rast|EBI
	mgAssembly = false
	//mgAssembler  = megahit|metaspades
	mtAssembly = false

	//Whether we the input reads are paired-end (two files, librarylayout="paired")
	//or single-end (one file, librarylayout="single")
	librarylayout = "paired"
	
	//Whether the de-duplication step should be performed
	dedup = false
	decontaminate = true
			
	//Whether the temporary files resulting from QC steps should be kept
	keepQCtmpfile = false
	//Whether the temporary files resulting from MetaPhlAn2 and HUMAnN2 should be kept
	keepCCtmpfile = false 

	//Whether alpha-diversity should be calculated
	alphadiversity = false

	/*--------------------------------*
	 *	PATHS TO EXTERNAL RESOURCES
	 *--------------------------------*/
		
	//Adapter sequences and synthetic contaminants to be removed in the trimming step
	adapters="/local/projects/drasko/thazen/scripts/illumina.adapters.current.fasta.txt"	
	artifacts="/local/projects-t3/MSL/pipelines/packages/YAMP/resources/sequencing_artifacts_null.fa"
	phix174ill="/local/projects/drasko/thazen/scripts/phiX174.fas"	
	
	//Reference pan-genome for contamination. It should have been indexed beforehand.
	//Actually the files are a bbmap index in the ./ref sub-directory
	refForeingGenome="/local/projects-t3/MSL/pipelines/packages/YAMP/resources/"
	
	// Kraken2 database
	kraken2_db="/local/scratch/jolim/kraken_dbs/standard+p+f+h"

	//BowTie2 database for MetaPhlAn2
	mpa_pkl="/usr/local/packages/metaphlan-2.7.8/metaphlan_databases/mpa_v20_m200.pkl"
	bowtie2db="/usr/local/packages/metaphlan-2.7.8/metaphlan_databases/"
	bowtie2dbfiles=""
	
	// ChocoPhlAn and UniRef databases
	chocophlan="/local/projects-t3/MSL/pipelines/packages/YAMP/resources/chocophlan"
	uniref="/local/projects-t3/MSL/pipelines/packages/YAMP/resources/uniref90/"	
	
	//[OPTIONAL]
    //Newick tree filepath, required for phylogenetic alpha diversity (PD_whole_tree, QIIME)
	treepath="null" 
	
	/*--------------------------------*
	 *	SOFTWARE PARAMETERS
	 *--------------------------------*/

	//BBduk parameters for trimming	
	qin=33 //Input quality offset: 33 (ASCII+33) or 64 (ASCII+64)
	kcontaminants = 23 //Kmer length used for finding contaminants	
	phred = 2 //regions with average (6-base?) quality BELOW this will be trimmed 
	minlength = 60 //reads shorter than this after trimming will be discarded
	// (https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3374609/)
	// (https://academic.oup.com/gigascience/article/7/7/giy072/5039705#118805999)
    mink = 11 //shorter kmers at read tips to look for 
	hdist = 1  //maximum Hamming distance for ref kmers        
	hdist2 = 2 //maximum Hamming distance for smaller (mink) 3' kmers  
	maq = 0 // discard reads below this average quality  
	mlf = 0 // discard reads that are less than this percent of original length

	//BBwrap parameters for decontamination	
	mind = 0.95 //Approximate minimum alignment identity to look for (http://seqanswers.com/forums/showthread.php?t=42552)
	maxindel = 3 //longest indel to look for
	bwr=0.16 //restrict alignment band to this
	
	//MetaPhlAn2 parameters 
	bt2options="very-sensitive" //presets options for BowTie2
}


process 
{
	//executor should be set to 'pbs' when a resource manager belonging to the 
	//PBS/Torque family of batch schedulers is used, or set to 'sge' when using  
	//a Sun Grid Engine cluster (or a compatible platform, e.g., Open Grid Engine)
	executor = 'sge'
	
	//Set the used queue, this queue will be used for all the processes	
	queue = 'threaded.q'
	penv = 'thread'
  	clusterOptions = {"-cwd -b n -P jravel-lab -V"}
	
	withName: qualityAssessment
	{
		time =  '15m'
		cpus = 4
		memory = '8 GB'	  
	}
	
	withName: dedup
	{
		time =  '1h'
		cpus = 4
		memory = '32 GB'  
	}	
	
	withName: trim 
	{
		time =  '1h'
		cpus = 4
		memory = '32 GB'  
	}	
	
	withName: decontaminate 
	{
		time =  '3h'
		cpus = 4
		memory = '32 GB'  
	}
	
	withName: profileTaxa 
	{
		time =  '2h'
		cpus = 4
		memory = '32 GB'  
	}
	
	withName: alphaDiversity
	{
		time =  '30m'
		cpus = 1
		memory = '8 GB'	  
	}
	
	withName: profileFunction 
	{
		time =  '24h'
		cpus = 4
		memory = '32 GB'  
	}	
	
	withName: logQC
	{
		time =  '15m'
		cpus = 1
		memory = '100 MB'  
	}
	
	withName: saveQCtmpfile
	{
		time =  '1h'
		cpus = 1
		memory = '4 GB'	  
	}	
	
	withName: logCC
	{
		time =  '15m'
		cpus = 1
		memory = '100 MB'	  
	}	
	
}